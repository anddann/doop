def defaultAnalyses = ['context-insensitive', '1-object-sensitive', '2-type-sensitive+heap']

def DaCapo2006 = ['antlr', 'bloat', 'chart', 'eclipse', 'fop', 'hsqldb', 'jython', 'luindex', 'lusearch', 'pmd', 'xalan']
def DaCapoBach = ['avrora', 'batik', 'eclipse', 'h2', 'jython', 'luindex', 'lusearch', 'pmd', 'sunflow', 'xalan']

///////////////////////////////////////////////////////////////////////////////

import org.apache.tools.ant.util.TeeOutputStream

def defaultCommonArgs = ['--timeout', '90', '--ssa', ,'--platform', 'java_7', '--cache']
def defaultOutDir     = '.'
def defaultPrefix     = ''
def commonArgs        = (project.hasProperty('commonArgs') ? project.property('commonArgs').split() : defaultCommonArgs)
def outDir            = (project.hasProperty('outDir') ? project.property('outDir') : defaultOutDir)
def suffix            = (project.hasProperty('suffix') ? project.property('suffix') : defaultPrefix)
def analyses          = (project.hasProperty('analyses') ? project.property('analyses').split() : defaultAnalyses)

def repoInfo
task collectRepoInfo (type: Exec) {
    commandLine 'hg id -i -b -t'.split()
    standardOutput = new ByteArrayOutputStream()
    doLast {
        repoInfo = standardOutput.toString().replace(' ', '-').trim()
    }
}
def templateLambda = { suiteName, benchmarks, specialArgs ->
    task "run-$suiteName" {
        dependsOn collectRepoInfo
        dependsOn << analyses.collect { analysis -> benchmarks.collect { BM -> "$suiteName-$analysis-$BM-info" } }
    }
    analyses.each { analysis -> 
        benchmarks.each { BM ->
            task "$suiteName-$analysis-$BM-info" (type: Exec) {
                commandLine 'bloxbatch -db last-analysis -popCount'.split()
                standardOutput = new ByteArrayOutputStream()
                doLast {
                    new File("${outDir}/${analysis}-${BM}-${suffix}-${repoInfo}.popCounts")
                        .text = standardOutput.toString().split('\n')
                            .findAll { !(it =~ /^Stats/) &&
                                       !(it =~ /^system/) &&
                                       !(it =~ '^\\$') &&
                                       !(it =~ ':\\$_none') &&
                                       !(it =~ /^derivationcounts/) }
                            .join('\n') + '\n'
                }
                dependsOn "$suiteName-$analysis-$BM"
            }
            task "$suiteName-$analysis-$BM" (type: JavaExec) {
                doFirst {
                    new File(outDir).mkdirs()
                    standardOutput = new TeeOutputStream(new FileOutputStream("${outDir}/${analysis}-${BM}-${suffix}-${repoInfo}.trace"), System.out);
                }
                classpath = sourceSets.main.runtimeClasspath
                main = 'org.clyze.doop.Main'

                def jarFile = "${environment.DOOP_BENCHMARKS}/$suiteName/${BM}.jar"
                args = ['-a', analysis, '-j', jarFile] + commonArgs + specialArgs
            }
        }
    }
}

templateLambda("dacapo-2006", DaCapo2006, ['--dacapo'])
templateLambda("dacapo-bach", DaCapoBach, ['--dacapo-bach'])
